os.loadAPI("apis/events")
os.loadAPI("apis/amber/core")

local function createInstallation()
	local client = amber.PackageClient.fromConfigurationPath(nil, {{type = "AmberServer"}})
	return amber.PackageInstallation.new(client, nil, editHandler, function(progress) print(progress) end)
end

function updatePackages(interactive)
	local editHandler
	if interactive then
		editHandler = function(file) shell.run("edit", "/" .. file) end
	end
	local installation = createInstallation()
	installation:updatePackages()
end

local function handleBundleUpdate(update)
	local installation = createInstallation()
	if installation:getInstalledPackage(update.packageUpdated) then
		installation:installBundle(update.bundle)
	end
end

-- TODO: This doesn't really belong here, but it's handy for now. Move to autostartup perhaps.
local function printSystemInfo()
	local label = os.getComputerLabel()
	local id = os.getComputerID()
	if label then
		print(string.format("Computer label: %s", label))
	end
	print(string.format("Computer ID: %i", id))
end

function initialize()
	net.registerMessageHandler("bundleUpdateAvailable", handleBundleUpdate)

	events.registerHandler("char", function(evt, pressed)
		if pressed == "u" then
			updatePackages(true)
		end
		if pressed == "i" then
			printSystemInfo()
		end
	end)
end